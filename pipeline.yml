pool:
  vmImage: ubuntu-20.04

steps:
- script: |
    curl -L https://nixos.org/nix/install | sh
    . ~/.nix-profile/etc/profile.d/nix.sh
  displayName: 'Install Nix'
- script: |
    . ~/.nix-profile/etc/profile.d/nix.sh
    nix-build nix/release.nix -A elemental.components.library -o result-build --option extra-substituters https://hydra.iohk.io --option trusted-public-keys 'cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ='
  displayName: 'Build'
- script: |
    . ~/.nix-profile/etc/profile.d/nix.sh
    nix-build nix/release.nix -A elemental.checks.test -o result-test
  displayName: 'Test'
- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/*.xml'
    searchFolder: '$(System.DefaultWorkingDirectory)/result-test'
    buildPlatform: 'Linux'
    failTaskOnFailedTests: true
